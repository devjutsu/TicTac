@using TicTac.Shared
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.SignalR.Client;
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject HttpClient Http
@inject HubConnection HubConnection

<AuthorizeView>
    <Authorized>
        <div><span>@context.User.Identity.Name</span> vs Player2</div>
        <p>&nbsp;</p>
        <button @onclick="StartGame" disabled="@(!IsConnected)">Start</button>
        <ul id="messagesList">
            @foreach (var message in messages)
            {
                <li>@message</li>
            }
        </ul>

        <div class="form-group">
            <label>
                User:
                <input @bind="userInput" />
            </label>
        </div>
        <div class="form-group">
            <label>
                Message:
                <input @bind="messageInput" size="50" />
            </label>
        </div>

        <div class="board">
            @for (int x = 0; x < 3; x++)
            {
                <div class="board-column">
                    @for (int y = 0; y < 3; y++)
                    {
                        <div class="gamepiece"
                     @onclick="@(() => board.PieceClicked(x, y))">
                            @x @y
                        </div>
                    }
                </div>
            }
        </div>
    </Authorized>
    <NotAuthorized>
        <LoginDisplay />
    </NotAuthorized>
</AuthorizeView>

@code {
    GameBoard board = new GameBoard();
    private string _name;
    private string _hubUrl;
    private string userInput;
    private string messageInput;

    private List<string> messages = new List<String>();

    public bool IsConnected =>
        HubConnection.State == HubConnectionState.Connected;

    async Task Send() =>
        await HubConnection.SendAsync("SendMessage", userInput, messageInput);

    protected override async Task OnInitializedAsync()
    {
        //var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        //var user = authState.User;
        //if (user.Identity.IsAuthenticated)
        //    _name = user.Identity.Name;

        //_returned = (await Http.GetFromJsonAsync<Psst>("toe")).Name;

        HubConnection.On<string>("StartGame", message =>
        {
            messages.Add(message);
            StateHasChanged();
        });

        await HubConnection.StartAsync();
    }

    public async Task StartGame()
    {
        Console.WriteLine("start game");
        await Http.GetAsync("toe/fire");
    }

    public async ValueTask DisposeAsync()
    {
        if (HubConnection is not null)
        {
            await HubConnection.DisposeAsync();
        }
    }
}